___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Heylink",
  "categories": [
    "AFFILIATE_MARKETING",
    "ADVERTISING"
  ],
  "brand": {
    "id": "Heylink",
    "displayName": "Heylink",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "days",
    "displayName": "Cookie expiration time (days)",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "taxRate",
    "displayName": "VAT rate",
    "simpleValueType": true,
    "defaultValue": 0.25
  },
  {
    "type": "RADIO",
    "name": "shippingVat",
    "displayName": "Shipping VAT",
    "radioItems": [
      {
        "value": "inclVat",
        "displayValue": "Shipping is tracked including VAT"
      },
      {
        "value": "exVat",
        "displayValue": "Shipping is tracked excluding VAT"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "setup",
    "displayName": "Event Data Setup Method",
    "radioItems": [
      {
        "value": "ga4",
        "displayValue": "Inherit from Ga4 Client"
      },
      {
        "value": "override",
        "displayValue": "Override"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Event type",
    "radioItems": [
      {
        "value": "page_view",
        "displayValue": "Page_view"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "setup",
        "paramValue": "override",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "orderTax",
    "displayName": "Tax",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Tax (vat) of the total order value"
  },
  {
    "type": "TEXT",
    "name": "orderId",
    "displayName": "Order id",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Order id of the purchase"
  },
  {
    "type": "TEXT",
    "name": "orderShipping",
    "displayName": "Shipping",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Shipping value of the purchase in the tracking"
  },
  {
    "type": "TEXT",
    "name": "orderTotal",
    "displayName": "Total value",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Total order value including tax"
  },
  {
    "type": "TEXT",
    "name": "orderCurrencyCode",
    "displayName": "Currency",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Currency code (DKK, NOK, EUR, USD etc.)",
    "defaultValue": "DKK"
  },
  {
    "type": "TEXT",
    "name": "orderCouponCode",
    "displayName": "Coupon",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Coupon code used on the purchase"
  },
  {
    "type": "CHECKBOX",
    "name": "includeProductData",
    "checkboxText": "Include Product Data",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "purchase",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "items",
    "displayName": "Google Analytics 4 Items",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "includeProductData",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

//# HeyLink Server Side Template
//# Last updated: 23MAR23@0846
const sendHttpRequest = require('sendHttpRequest');
const setResponseBody = require('setResponseBody');
const setResponseStatus = require('setResponseStatus');
const getEventData = require('getEventData');
const parseUrl = require('parseUrl');
const logToServerConsole = require('logToConsole');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const JSON = require('JSON');
const makeNumber = require('makeNumber');
//--------------------------------------

// Setup
const expirationTime = (data.days * 24 * 60 * 60);
const serverSideookieName = 'hltid_ss';
const debugOn = false;

// Customer end-point url to send server-side data to
const apiUrl = 'https://heylinkapi.com/connect/v1/callbacks/advertisers';

//--------------------------------------
// set cookie 
if (getEvetName() == 'page_view') {
    debugLogger('[page_view] initiated');
  
    const hltid = parseUrl(getEventData('page_location')).searchParams.hltid;
  
    if (hltid)
      setCookie(serverSideookieName, hltid, {'max-age': expirationTime, sameSite: 'lax',  httpOnly: true, domain: 'auto', path: '/', secure: true});
      
    if(debugOn) logToServerConsole('[GTM - Server Template] Setup Method is set to: ' + data.setup);
  
    debugLogger('[page_view] done');
}

// track conversion
if(getEvetName() == 'purchase') {
  var affiliateCookieId = getCookieValues(serverSideookieName)[0];
  
   if (affiliateCookieId) {
       debugLogger('[purchase] initiated');
       debugLogger('[purchase] received hltid: ' + affiliateCookieId);
          
     // order items
     var items;
     
     if(data.setup === "override")
       items = data.items;
      else
       items = getEventData('items');
     
     var order_items = [];
     for (var i = 0; i < items.length; i++) {
      order_items.push({
        'itemId': items[i].item_id,
        'itemName': items[i].item_name,
        'itemPrice': items[i].price,
        'itemQuantity': items[i].quantity,
        'itemCategoryName': items[i].item_category,
      }
      );
     }
     
       if(debugOn) logToServerConsole('[GTM - Server Template] Setup Method is set to: ' + data.setup);  
       var override = false;
       var inputOrderId, inputOrderShipping, inputOrderTax, inputOrderTotal, inputOrderCurrencyCode, inputOrderCouponCode;
     
       if(data.setup === "override") {
         inputOrderId = data.orderId;
         inputOrderShipping = data.orderShipping;
         inputOrderTax = data.orderTax;
         inputOrderTotal = data.orderTotal;
         inputOrderCurrencyCode = data.orderCurrencyCode;
         inputOrderCouponCode = data.orderCouponCode;
       } else {
         inputOrderId = getEventData('transaction_id');
         inputOrderShipping = getEventData('shipping');
         inputOrderTax = getEventData('tax');
         inputOrderTotal = getEventData('value');
         inputOrderCurrencyCode = getEventData('currency');
         inputOrderCouponCode = getEventData('coupon');
       }
     
     // adjust shipping for tax
         var orderShippingSubTotal;
         var orderShipping;
       
     if (makeNumber(inputOrderShipping) === 0 || makeNumber(data.taxRate) === 0) {
         orderShippingSubTotal = 0;
     } else if (data.shippingVat == "inclVat")  {
           orderShippingSubTotal = makeNumber(inputOrderShipping) / (1 + makeNumber(data.taxRate));
           orderShipping = makeNumber(inputOrderShipping);
         }
         else {
           orderShippingSubTotal = makeNumber(inputOrderShipping);    
         }
     
       
    // payload
     const payload = {
       hltid: getCookieValues('hltid_ss')[0],
       offerId: getCookieValues('hlofid_ss')[0],
       orderId: inputOrderId,
       orderShipping: orderShipping,
       orderShippingSubTotal: orderShippingSubTotal,
       orderTax: inputOrderTax,
       orderTaxRate: data.orderTaxRate,
       orderTotal: inputOrderTotal,  
       orderSubTotal: makeNumber(inputOrderTotal) - makeNumber(inputOrderTax) - makeNumber(orderShippingSubTotal),
       orderCurrencyCode: inputOrderCurrencyCode,
       // orderDiscount: undefined,
       orderCouponCode: inputOrderCouponCode,
       orderItems: order_items
     };
     
     debugLogger('payload: '+ JSON.stringify(payload));
    
     // delete cookie
     setCookie(serverSideookieName, '', {'max-age': 0, sameSite: 'lax',  httpOnly: true, domain: 'auto', path: '/', secure: true});
     
    // send data to customer end-point
    debugLogger('[purchase] Will try to send data to customer end-point now on url:');
    debugLogger('[purchase] ' + apiUrl);
     
     let endPointParams = '/?pageUrl=' + getEventData('page_location');
         endPointParams += '&secretKey=' + data.secretKey;
     
     let endPointUrl = apiUrl;
     
    sendHttpRequest(endPointUrl, {
      headers: {'Content-Type': 'application/json'},
      method: 'POST',
      timeout: 1000,
      }, JSON.stringify(payload)).then((result) => {
        setResponseStatus(result.statusCode);
        setResponseBody(result.body);
        onSuccess();
      });
  }
}

function getEvetName() {
  return getEventData('event_name');
}

function onSuccess() {
  debugLogger('Send: Success');
}

function onFailure() {
  debugLogger('Send: Failure');
}

function debugLogger(msg) {
  if(debugOn) logToServerConsole('[GTM - Server Template] ' + msg);
}

data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "hlofid_ss"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "hltid_ss"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "hltid_ss"
              },
              {
                "type": 1,
                "string": "hlofid_ss"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://heylinkapi.com/connect/v1/callbacks/advertisers"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 10.11.2022 12.32.35


